#!/usr/bin/env bash

# Το παρόν shell script χρησιμοποιείται για το φόρτωμα των CDRs στην database.
# By default απλώς διαβάζει τα CDRs και εκτυπώνει τα πεδία που μας ενδιαφέρουν
# στο standard output. Αν επιθυμούμε εισαγωγή των στοιχείων στην database, θα
# πρέπει να χρησιμοποιήσουμε είτε την option -i (insert) είτε την option -r
# (replace). Παρέχεται, ακόμη, και η option -m με την οποία εκτυπώνονται
# εκτυπώνονται μηνύματα προόδου στο standard output.

progname=$(basename $0)

[ -z "${CDR_BASEDIR}" ] &&
export CDR_BASEDIR="/var/opt/cdr"

usage() {
	echo "usage: ${progname} [-i] [-r]"
	exit 1
}

err=
mode=
check=
monitor=

while getopts ":cirm" opt
do
	case "${opt}" in
	c)
		check="yes"
		;;
	i)
		mode="INSERT"
		;;
	r)
		mode="REPLACE"
		;;
	m)
		monitor="yes"
		;;
	\?)
		echo "${progname}: -${OPTARG}: invalid option" >&2
		err=1
		;;
	esac
done

[ -n "${err}" ] &&
usage

shift $(expr ${OPTIND} - 1)

awkcmd="awk "
awkcmd="${awkcmd} -v mode=${mode}"
awkcmd="${awkcmd} -v check=${check} "
awkcmd="${awkcmd} -v monitor=${monitor} "
awkcmd="${awkcmd} -l ${CDR_BASEDIR}/lib/cdrawk.so"
awkcmd="${awkcmd} -f ${CDR_BASEDIR}/lib/cdr.awk"
awkcmd="${awkcmd} -f ${CDR_BASEDIR}/lib/cdrparse.awk"
awkcmd="${awkcmd} -f ${CDR_BASEDIR}/lib/cdrload.awk"

eval ${awkcmd} $*

exit 0
